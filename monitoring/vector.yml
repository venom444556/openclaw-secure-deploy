# Vector — Unified log shipper for The Commission observability stack
# Replaces Promtail. Ships Docker container logs + eslogger audit events to Loki.

api:
  enabled: true
  address: "0.0.0.0:8686"

# ── Sources ──────────────────────────────────────────────────

sources:
  docker_logs:
    type: docker_logs
    docker_host: "unix:///var/run/docker.sock"

  es_audit:
    type: file
    include:
      - /var/log/commission-audit/audit.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

# ── Transforms ───────────────────────────────────────────────

transforms:
  docker_enriched:
    type: remap
    inputs:
      - docker_logs
    source: |
      .source_type = "docker"
      .service = string!(.container_name)
      if starts_with(.service, "pgpclaw-") {
        .service = slice!(.service, 8)
      }

  audit_parsed:
    type: remap
    inputs:
      - es_audit
    drop_on_abort: false
    source: |
      .source_type = "eslogger"
      msg = string!(.message)

      # Set defaults
      .event_type = "unknown"
      .uid = ""
      .user = "system"
      .path = ""
      .process = ""

      # eslogger outputs JSON — parse it
      parsed, err = parse_json(msg)
      if err == null {
        # Event type — eslogger uses integers (e.g. 9=exec), convert to string
        et = parsed.event_type
        if et != null { .event_type = to_string!(et) }

        # Extract UID from process info
        proc_info = parsed.process
        if proc_info != null {
          audit_token = proc_info.audit_token
          if audit_token != null {
            uid_val = audit_token.euid
            if uid_val != null {
              .uid = to_string!(uid_val)
              if .uid == "599" {
                .user = "claude"
              } else if .uid == "600" {
                .user = "secureclaw"
              }
            }
          }
          # Process executable path
          exe = proc_info.executable
          if exe != null {
            exe_path = exe.path
            if exe_path != null { .process = to_string!(exe_path) }
          }
        }

        # Extract file path from event-specific data
        event_data = parsed.event
        if event_data != null {
          # For exec events
          target = event_data.target
          if target != null {
            exec_path = target.executable
            if exec_path != null {
              ep = exec_path.path
              if ep != null { .path = to_string!(ep) }
            }
          }
          # For file events (open, write, rename, unlink)
          file_info = event_data.file
          if file_info != null {
            fp = file_info.path
            if fp != null { .path = to_string!(fp) }
          }
        }
      }

# ── Sinks ────────────────────────────────────────────────────

sinks:
  loki_docker:
    type: loki
    inputs:
      - docker_enriched
    endpoint: "http://pgpclaw-loki:3100"
    labels:
      source: "docker"
      service: "{{ service }}"
      stream: "{{ stream }}"
    encoding:
      codec: text

  loki_audit:
    type: loki
    inputs:
      - audit_parsed
    endpoint: "http://pgpclaw-loki:3100"
    labels:
      source: "eslogger"
      user: "{{ user }}"
      event_type: "{{ event_type }}"
      service: "commission-audit"
    encoding:
      codec: text
