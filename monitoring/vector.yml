# Vector — Unified log shipper for The Commission observability stack
# Replaces Promtail. Ships Docker container logs + OpenBSM audit logs to Loki.

api:
  enabled: true
  address: "0.0.0.0:8686"

# ── Sources ──────────────────────────────────────────────────

sources:
  docker_logs:
    type: docker_logs
    docker_host: "unix:///var/run/docker.sock"

  bsm_audit:
    type: file
    include:
      - /var/log/commission-audit/audit.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

# ── Transforms ───────────────────────────────────────────────

transforms:
  docker_enriched:
    type: remap
    inputs:
      - docker_logs
    source: |
      .source_type = "docker"
      .service = string!(.container_name)
      if starts_with(.service, "pgpclaw-") {
        .service = slice!(.service, 8)
      }

  bsm_parsed:
    type: remap
    inputs:
      - bsm_audit
    source: |
      .source_type = "openbsm"
      msg = string!(.message)

      # Set defaults
      .event_type = "unknown"
      .uid = ""
      .user = "system"
      .path = ""
      .process = ""

      # Extract event type (e.g., AUE_EXECVE, AUE_OPEN_RW)
      parsed, err = parse_regex(msg, r'<event.*?modifier="(?P<event>[^"]+)"')
      if err == null { .event_type = string!(parsed.event) }

      # Extract subject UID and map to username
      parsed, err = parse_regex(msg, r'<subject.*?uid="(?P<uid>\d+)"')
      if err == null {
        .uid = string!(parsed.uid)
        if .uid == "599" {
          .user = "claude"
        } else if .uid == "600" {
          .user = "secureclaw"
        }
      }

      # Extract path if present
      parsed, err = parse_regex(msg, r'<path>(?P<path>[^<]+)</path>')
      if err == null { .path = string!(parsed.path) }

      # Extract process name if present
      parsed, err = parse_regex(msg, r'<exec_args>.*?<arg>(?P<proc>[^<]+)</arg>')
      if err == null { .process = string!(parsed.proc) }

# ── Sinks ────────────────────────────────────────────────────

sinks:
  loki_docker:
    type: loki
    inputs:
      - docker_enriched
    endpoint: "http://pgpclaw-loki:3100"
    labels:
      source: "docker"
      service: "{{ service }}"
      stream: "{{ stream }}"
    encoding:
      codec: text

  loki_audit:
    type: loki
    inputs:
      - bsm_parsed
    endpoint: "http://pgpclaw-loki:3100"
    labels:
      source: "openbsm"
      user: "{{ user }}"
      event_type: "{{ event_type }}"
      service: "commission-audit"
    encoding:
      codec: text
