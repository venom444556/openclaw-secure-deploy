groups:
  - name: pgpclaw.security
    rules:

      - alert: HighAPIUsage
        expr: sum(rate(openclaw_api_tokens_total[1h])) > 1000000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "OpenClaw API usage spike"
          description: "Token usage exceeded 1M/hr — possible abuse or runaway agent"

      - alert: SandboxFailures
        expr: sum(increase(openclaw_sandbox_containers_total{status="failed"}[1h])) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Sandbox container failures"
          description: "{{ $value }} sandbox failures in last hour"

      - alert: AuthFailures
        expr: sum(increase(openclaw_auth_failures_total[5m])) > 5
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Multiple auth failures detected"
          description: "Possible brute-force attack — {{ $value }} failures in 5 min"

      - alert: GatewayDown
        expr: up{job="openclaw-gateway"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "OpenClaw gateway is DOWN"
          description: "Gateway has been unreachable for 2+ minutes"

  - name: pgpclaw.cost
    rules:

      - alert: HourlyCostHigh
        expr: sum(rate(openclaw_api_tokens_total{type="output"}[1h])) * 0.000075 > 20
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API cost exceeding $20/hour"
          description: "Current hourly burn rate: ${{ $value | humanize }}"

      - alert: MonthlyCostProjectionHigh
        expr: (sum(rate(openclaw_api_tokens_total{type="output"}[24h])) * 0.000075) * 30 > 2000
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Projected monthly API cost > $2000"
          description: "At current rate, monthly cost: ${{ $value | humanize }}"

  # -- OpenBao Alerts ----------------------------------------------------------
  - name: pgpclaw.openbao
    rules:

      - alert: OpenBaoSealed
        expr: openbao_core_unsealed == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "OpenBao is SEALED"
          description: >-
            OpenBao has been sealed for over 1 minute. All secret access is
            blocked. Run: ./openbao/scripts/unseal-bao.sh

      - alert: OpenBaoDown
        expr: up{job="openbao"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "OpenBao is unreachable"
          description: >-
            Prometheus cannot scrape OpenBao metrics. The container may be
            stopped. Run: docker start pgpclaw-openbao

      - alert: OpenBaoHighAuthFailures
        expr: increase(openbao_core_handle_login_request{error="true"}[5m]) > 10
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High OpenBao auth failure rate"
          description: >-
            {{ $value }} failed login attempts in 5 minutes. Possible brute-force
            against AppRole. Review audit log: docker logs pgpclaw-openbao

      - alert: OpenBaoTokenLeaseExpiry
        expr: openbao_expire_num_leases > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "OpenBao lease accumulation"
          description: >-
            {{ $value }} active leases. This may indicate leaked tokens or
            missing revocation in ephemeral runners.

  # -- Nango Alerts ------------------------------------------------------------
  - name: pgpclaw.nango
    rules:

      - alert: NangoDown
        expr: up{job="nango-server"} == 0
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Nango OAuth proxy is unreachable"
          description: >-
            Nango server has been down for 3+ minutes. OAuth-protected
            integrations (Gmail, GitHub, etc.) are unavailable.
