global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'pgpclaw'

# -- Alerting Rules -----------------------------------------------------------
rule_files:
  - /etc/prometheus/alerts.yml
  - /etc/prometheus/msd-alerts.yml

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['pgpclaw-alertmanager:9093']

# -- Scrape Targets ------------------------------------------------------------
# NOTE: All targets use Docker container names (resolved via pgpclaw-internal network).
# "localhost" inside a container refers to the container itself, not the host.
#
# Services with native Prometheus metrics: prometheus, grafana, alertmanager
# Services without metrics: openbao, openclaw-gateway, n8n, nango — probed via blackbox exporter.

scrape_configs:

  # -- Prometheus (self) -------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # -- Grafana -----------------------------------------------------------------
  - job_name: 'grafana'
    static_configs:
      - targets: ['pgpclaw-grafana:3000']
    metrics_path: '/metrics'

  # -- Alertmanager ------------------------------------------------------------
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['pgpclaw-alertmanager:9093']
    metrics_path: '/metrics'

  # -- Blackbox Exporter (self-metrics) ----------------------------------------
  - job_name: 'blackbox-exporter'
    static_configs:
      - targets: ['pgpclaw-blackbox:9115']
    metrics_path: '/metrics'

  # ============================================================================
  # HTTP Probe Targets (via Blackbox Exporter)
  # These services don't expose /metrics — we probe their health endpoints.
  # ============================================================================

  # -- Probe: OpenBao ----------------------------------------------------------
  - job_name: 'probe-openbao'
    metrics_path: /probe
    params:
      module: [http_2xx_json]
    static_configs:
      - targets: ['http://pgpclaw-openbao:8200/v1/sys/health']
        labels:
          service: openbao
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: pgpclaw-blackbox:9115

  # -- Probe: OpenClaw Gateway -------------------------------------------------
  - job_name: 'probe-openclaw-gateway'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets: ['http://pgpclaw-gateway:18789/health']
        labels:
          service: openclaw-gateway
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: pgpclaw-blackbox:9115

  # -- Probe: n8n --------------------------------------------------------------
  - job_name: 'probe-n8n'
    metrics_path: /probe
    params:
      module: [http_2xx_json]
    static_configs:
      - targets: ['http://pgpclaw-n8n:5678/healthz']
        labels:
          service: n8n
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: pgpclaw-blackbox:9115

  # -- Probe: Nango Server -----------------------------------------------------
  - job_name: 'probe-nango'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets: ['http://pgpclaw-nango-server:3003/health']
        labels:
          service: nango
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: pgpclaw-blackbox:9115

  # ============================================================================
  # Mac Studio Decision — Additional Scrape Targets
  # ============================================================================

  # -- Node Exporter (Host System Metrics) ------------------------------------
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['msd-node-exporter:9100']

  # -- cAdvisor (Container Metrics) -------------------------------------------
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['msd-cadvisor:8080']

  # -- Anthropic API Cost Tracker ---------------------------------------------
  - job_name: 'api-tracker'
    static_configs:
      - targets: ['msd-api-tracker:9101']

  # -- Probe: StoryFlow (native Node — host gateway 172.19.0.1) -----------------
  # NOTE: StoryFlow binds to 127.0.0.1 by default. For this probe to succeed,
  # restart StoryFlow with: STORYFLOW_HOST=0.0.0.0 npm run server
  # Until then, probe_success will be 0 (DOWN) — which is correct and visible.
  - job_name: 'probe-storyflow'
    metrics_path: /probe
    params:
      module: [http_2xx_json]
    static_configs:
      - targets: ['http://172.19.0.1:3001/api/projects']
        labels:
          service: storyflow
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: pgpclaw-blackbox:9115

  # -- Probe: API Tracker health endpoint --------------------------------------
  - job_name: 'probe-api-tracker'
    metrics_path: /probe
    params:
      module: [http_2xx_json]
    static_configs:
      - targets: ['http://msd-api-tracker:9101/health']
        labels:
          service: api-tracker
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: pgpclaw-blackbox:9115

  # -- n8n Workflow Metrics (native) ------------------------------------------
  # Requires N8N_METRICS=true on the n8n container
  - job_name: 'n8n-metrics'
    static_configs:
      - targets: ['pgpclaw-n8n:5678']
    metrics_path: /metrics
    scrape_interval: 30s
